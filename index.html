<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ì¥ ì •ì‚° ì‹œìŠ¤í…œ - ë°±ì—… ë° ì´ˆê¸°í™” ê´€ë¦¬ ë²„ì „</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .drop-zone { border: 3px dashed #cbd5e1; border-radius: 12px; padding: 50px; text-align: center; color: #475569; background: #f8fafc; cursor: pointer; margin-bottom: 20px; }
        .drop-zone.dragover { background: #e0f2fe; border-color: var(--primary); }

        .admin-controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; }
        .btn-backup { background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-reset { background: var(--danger); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .added-item-tag { display: flex; align-items: center; justify-content: space-between; background: #eff6ff; padding: 12px; border-radius: 12px; margin: 8px 0; border: 1px solid #bfdbfe; }
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-size: 13px; }
        .staff-group { margin-bottom: 30px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: #fff; }
        .staff-header { background: #f1f5f9; padding: 15px 20px; border-bottom: 1px solid #cbd5e1; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('input-tab')">ë‚´ìˆ˜ ì…ë ¥</button>
        <button class="tab-btn" onclick="openTab('history-tab')">ë‚´ì—­ ë³´ê¸°</button>
        <button class="tab-btn" onclick="openTab('setting-tab')">ë¬¼ê±´ ì„¤ì • ë° ë¦¬ìŠ¤íŠ¸</button>
    </div>

    <div id="input-tab" class="tab-content active">
        <h2>ğŸ“‚ ì—‘ì…€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h2>
        <div id="drop-zone" class="drop-zone">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”.</div>
        <input type="file" id="excel-input" style="display:none;">

        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #e2e8f0;">

        <h2>âœï¸ ìˆ˜ë™ ì…ë ¥ ë° ì „ì†¡ ëŒ€ê¸°</h2>
        <div style="margin-bottom: 15px;">
            <label>ì§ì› ì´ë¦„</label>
            <input type="text" id="staff-name" placeholder="ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px; position: relative;">
            <label>ë¬¼ê±´ ê²€ìƒ‰</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="item-search" placeholder="ì œí’ˆëª… ì…ë ¥" oninput="searchItem(this.value)" style="flex-grow:1; padding:12px; border:1px solid #cbd5e1; border-radius:8px;">
                <input type="number" id="item-qty-input" value="1" min="1" style="width: 80px; padding:12px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>
            <div id="autocomplete-box" style="position:absolute; background:white; border:1px solid #ddd; width:100%; z-index:100; display:none; border-radius:8px;"></div>
        </div>

        <div id="selected-items-display"></div>
        <div style="margin: 20px 0; font-size: 1.2rem;"><strong>ì „ì†¡ ëŒ€ê¸° í•©ê³„: <span id="total-amount" style="color:var(--primary)">0</span>ì›</strong></div>
        <button class="main-btn" onclick="submitLog()">Firebase ìµœì¢… ì „ì†¡</button>
    </div>

    <div id="history-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ğŸ‘¤ ì§ì›ë³„ ìƒì„¸ ì •ì‚° ë³´ê³ ì„œ</h2>
            <div class="admin-controls">
                <button class="btn-backup" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë°±ì—…(ë‹¤ìš´ë¡œë“œ)</button>
                <button class="btn-reset" onclick="resetAllLogs()">âš ï¸ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>
        <div id="history-container"></div>
    </div>

    <div id="setting-tab" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h2>ğŸ›  ìƒˆ ë¬¼ê±´ ë“±ë¡</h2>
                <input type="text" id="new-item-name" placeholder="í’ˆëª©ëª…" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:10px;">
                <input type="number" id="new-item-price" placeholder="ë‹¨ê°€" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:10px;">
                <select id="new-item-category" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:10px;">
                    <option value="ì§ì›ë‚´ìˆ˜">ì§ì›ë‚´ìˆ˜</option><option value="CL">CL</option><option value="ê°€ë°œ">ê°€ë°œ</option>
                    <option value="ë¸”ë¡œê±°ST">ë¸”ë¡œê±°ST</option><option value="ì¬ì‹œìˆ ">ì¬ì‹œìˆ </option><option value="ëª…í•¨">ëª…í•¨</option>
                </select>
                <button class="main-btn" onclick="regItem()">ë¬¼ê±´ ë“±ë¡</button>
            </div>
            <div>
                <h2>ğŸ“‹ ë“±ë¡ëœ ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸</h2>
                <div id="master-item-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCGI5gtzwYM9vyRMS5qhTaNsFZ8rZDK-o",
        authDomain: "clac-efaab.firebaseapp.com",
        databaseURL: "https://clac-efaab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "clac-efaab",
        appId: "1:94106141769:web:5391ba91c0300bf652ab98"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let masterItems = {};
    let selectedBasket = [];
    let currentLogs = {}; // ë°±ì—…ì„ ìœ„í•´ í˜„ì¬ ë¡œê·¸ ì €ì¥

    db.ref('items').on('value', (snap) => { masterItems = snap.val() || {}; renderMasterList(); });
    db.ref('logs').on('value', (snap) => { 
        currentLogs = snap.val() || {}; 
        renderHistory(currentLogs); 
    });

    // --- íŒŒì¼ ì²˜ë¦¬ ë¡œì§ ---
    const dropZone = document.getElementById('drop-zone');
    const excelInput = document.getElementById('excel-input');

    dropZone.onclick = () => excelInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#2563eb"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#cbd5e1"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleExcel(file);
    };
    excelInput.onchange = (e) => { if (e.target.files[0]) handleExcel(e.target.files[0]); };

    function handleExcel(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', codepage: 949 });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            processExcelData(rows);
        };
        reader.readAsArrayBuffer(file);
    }

    function processExcelData(rows) {
        let addCount = 0;
        rows.forEach((row, index) => {
            if (index < 5) return;
            const menuName = String(row[5] || "").trim();
            const staffName = String(row[6] || "").trim();
            if (!menuName || !staffName || menuName === "ìƒì„¸ë©”ë‰´") return;

            const matchedKey = Object.keys(masterItems).find(key => 
                key.trim().replace(/\s/g, "") === menuName.replace(/\s/g, "")
            );

            if (matchedKey) {
                const item = masterItems[matchedKey];
                selectedBasket.push({
                    staff: staffName,
                    itemName: matchedKey,
                    unitPrice: item.price,
                    qty: 1,
                    totalPrice: item.price,
                    category: item.category
                });
                addCount++;
            }
        });
        renderBasket();
        alert(addCount + "ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
    }

    // --- ë°±ì—… ë° ì´ˆê¸°í™” ë¡œì§ (New) ---
    function exportToExcel() {
        if (Object.keys(currentLogs).length === 0) return alert("ë°±ì—…í•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");

        const data = Object.values(currentLogs).map(log => ({
            "ë‚ ì§œ": new Date(log.timestamp).toLocaleString(),
            "ì§ì›ëª…": log.staff,
            "ë¶„ë¥˜": log.category,
            "í’ˆëª©ëª…": log.itemName,
            "ìˆ˜ëŸ‰": log.qty,
            "ê¸ˆì•¡": log.price
        }));

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ì •ì‚°ë‚´ì—­");
        
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(workbook, `ë§¤ì¥ì •ì‚°ë°±ì—…_${dateStr}.xlsx`);
    }

    function resetAllLogs() {
        if (!confirm("âš ï¸ ì£¼ì˜: ëª¨ë“  ì •ì‚° ë‚´ì—­ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\nì´ë¯¸ ì—‘ì…€ë¡œ ë°±ì—…í•˜ì…¨ë‚˜ìš”?")) return;
        if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            db.ref('logs').remove()
                .then(() => alert("ëª¨ë“  ë‚´ì—­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë‹¬ì„ ì‹œì‘í•˜ì„¸ìš”!"))
                .catch((err) => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
        }
    }

    // --- ìˆ˜ë™ ì…ë ¥ ë° ë Œë”ë§ ---
    function searchItem(val) {
        const box = document.getElementById('autocomplete-box');
        if(!val) { box.style.display = 'none'; return; }
        const matches = Object.keys(masterItems).filter(k => k.includes(val));
        if(matches.length > 0) {
            box.innerHTML = matches.map(m => `<div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;" onclick="addItemToBasket('${m}')">${m}</div>`).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    }

    function addItemToBasket(name) {
        const staff = document.getElementById('staff-name').value || "ë¯¸ì§€ì •";
        const qty = Number(document.getElementById('item-qty-input').value) || 1;
        selectedBasket.push({ staff, itemName: name, unitPrice: masterItems[name].price, qty, totalPrice: masterItems[name].price * qty, category: masterItems[name].category });
        renderBasket();
        document.getElementById('autocomplete-box').style.display = 'none';
        document.getElementById('item-search').value = '';
    }

    function renderBasket() {
        const display = document.getElementById('selected-items-display');
        display.innerHTML = selectedBasket.map((item, idx) => `
            <div class="added-item-tag">
                <div><b>[${item.staff}]</b> ${item.itemName} (${item.unitPrice.toLocaleString()}ì›)</div>
                <div style="cursor:pointer; color:red; font-weight:bold;" onclick="selectedBasket.splice(${idx}, 1); renderBasket();">âœ•</div>
            </div>`).join('');
        document.getElementById('total-amount').innerText = selectedBasket.reduce((s, c) => s + c.totalPrice, 0).toLocaleString();
    }

    function submitLog() {
        if(selectedBasket.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        selectedBasket.forEach(i => db.ref('logs').push({ ...i, timestamp: Date.now() }));
        selectedBasket = []; renderBasket(); alert("Firebase ì €ì¥ ì™„ë£Œ!");
    }

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    function regItem() {
        const name = document.getElementById('new-item-name').value;
        const price = Number(document.getElementById('new-item-price').value);
        const category = document.getElementById('new-item-category').value;
        if(name && price) db.ref('items/' + name).set({ price, category });
    }

    function renderMasterList() {
        let html = '<table><tr><th>í’ˆëª©</th><th>ë‹¨ê°€</th><th>ì‚­ì œ</th></tr>';
        Object.entries(masterItems).forEach(([n, d]) => {
            html += `<tr><td>${n}</td><td>${d.price.toLocaleString()}</td><td><button class="del-btn" onclick="db.ref('items/${n}').remove()">ì‚­ì œ</button></td></tr>`;
        });
        document.getElementById('master-item-list').innerHTML = html + '</table>';
    }

    function renderHistory(logs) {
        const container = document.getElementById('history-container');
        const groups = {};
        Object.values(logs).forEach(log => {
            if(!groups[log.staff]) groups[log.staff] = { items: [], total: 0 };
            groups[log.staff].items.push(log);
            groups[log.staff].total += log.price;
        });
        let html = '';
        Object.entries(groups).forEach(([staff, data]) => {
            html += `<div class="staff-group">
                <div class="staff-header"><b>ğŸ‘¤ ${staff}</b> <span>(í•©ê³„: ${data.total.toLocaleString()}ì›)</span></div>
                <table>
                    ${data.items.map(i => `<tr><td style="text-align:left; padding-left:20px;">${i.itemName}</td><td style="width:150px;">${(i.price || 0).toLocaleString()}ì›</td></tr>`).join('')}
                </table>
            </div>`;
        });
        container.innerHTML = html || '<p>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì •ì‚°ì„ ì‹œì‘í•˜ì„¸ìš”!</p>';
    }
</script>
</body>
</html>
