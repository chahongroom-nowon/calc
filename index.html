<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ì¥ ì •ì‚° ì‹œìŠ¤í…œ - ì—‘ì…€ í˜¸í™˜ì„± ìµœì¢… ìˆ˜ì •</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; color: #64748b; background: #f1f5f9; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .drop-zone.dragover { background: #e0f2fe; border-color: var(--primary); color: var(--primary); }
        .form-group { margin-bottom: 15px; position: relative; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .added-item-tag { display: flex; align-items: center; justify-content: space-between; background: #eff6ff; padding: 8px 15px; border-radius: 12px; margin: 6px 0; border: 1px solid #bfdbfe; }
        .item-info { flex-grow: 1; }
        .item-remove { color: #ef4444; cursor: pointer; font-weight: bold; padding: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-size: 13px; }
        .staff-group { margin-bottom: 40px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .staff-header { background: #f1f5f9; padding: 15px 20px; border-bottom: 1px solid #cbd5e1; }
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .del-btn { background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('input-tab')">ë‚´ìˆ˜ ì…ë ¥</button>
        <button class="tab-btn" onclick="openTab('history-tab')">ë‚´ì—­ ë³´ê¸°</button>
        <button class="tab-btn" onclick="openTab('setting-tab')">ë¬¼ê±´ ì„¤ì • ë° ë¦¬ìŠ¤íŠ¸</button>
    </div>

    <div id="input-tab" class="tab-content active">
        <h2>ğŸ“‚ ì—‘ì…€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ì§€ í˜•ì‹ ìµœì í™”)</h2>
        <div id="drop-zone" class="drop-zone">
            ì´ë¯¸ì§€ì˜ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”. <br>
            <small>â€» ì•ˆ ë  ê²½ìš° íŒŒì¼ì„ ì—´ì–´ <b>.xlsx</b>ë¡œ ë‹¤ì‹œ ì €ì¥ í›„ ì‹œë„í•´ ë³´ì„¸ìš”.</small>
        </div>
        <input type="file" id="excel-input" style="display:none;">

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">

        <h2>âœï¸ ìˆ˜ë™ ì…ë ¥ ë° ì „ì†¡ ëŒ€ê¸°</h2>
        <div class="form-group">
            <label>ì§ì› ì´ë¦„</label>
            <input type="text" id="staff-name" placeholder="ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
            <label>ë¬¼ê±´ ê²€ìƒ‰</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="item-search" placeholder="ì œí’ˆëª… ì…ë ¥" oninput="searchItem(this.value)" onkeydown="handleKeyDown(event)">
                <input type="number" id="item-qty-input" value="1" min="1" style="width: 80px;">
            </div>
            <div id="autocomplete-box" style="position:absolute; background:white; border:1px solid #ddd; width:100%; z-index:100; display:none;"></div>
        </div>

        <div id="selected-items-display"></div>
        <div style="margin: 20px 0; font-size: 1.2rem;"><strong>ì „ì†¡ ëŒ€ê¸° í•©ê³„: <span id="total-amount" style="color:var(--primary)">0</span>ì›</strong></div>
        <button class="main-btn" onclick="submitLog()">ìµœì¢… ë°ì´í„° Firebase ì „ì†¡</button>
    </div>

    <div id="history-tab" class="tab-content">
        <h2>ğŸ‘¤ ì§ì›ë³„ ìƒì„¸ ì •ì‚° ë³´ê³ ì„œ</h2>
        <div id="history-container"></div>
    </div>

    <div id="setting-tab" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h2>ğŸ›  ìƒˆ ë¬¼ê±´ ë“±ë¡</h2>
                <div class="form-group"><input type="text" id="new-item-name" placeholder="í’ˆëª©ëª…"></div>
                <div class="form-group"><input type="number" id="new-item-price" placeholder="ë‹¨ê°€"></div>
                <div class="form-group">
                    <select id="new-item-category">
                        <option value="ì§ì›ë‚´ìˆ˜">ì§ì›ë‚´ìˆ˜</option>
                        <option value="CL">CL</option>
                        <option value="ê°€ë°œ">ê°€ë°œ</option>
                        <option value="ë¸”ë¡œê±°ST">ë¸”ë¡œê±°ST</option>
                        <option value="ì¬ì‹œìˆ ">ì¬ì‹œìˆ </option>
                        <option value="ëª…í•¨">ëª…í•¨</option>
                    </select>
                </div>
                <button class="main-btn" onclick="regItem()">ë¬¼ê±´ ë“±ë¡</button>
            </div>
            <div>
                <h2>ğŸ“‹ ë“±ë¡ëœ ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸</h2>
                <div id="master-item-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCGI5gtzwYM9vyRMS5qhTaNsFZ8rZDK-o",
        authDomain: "clac-efaab.firebaseapp.com",
        databaseURL: "https://clac-efaab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "clac-efaab",
        appId: "1:94106141769:web:5391ba91c0300bf652ab98"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let masterItems = {};
    let selectedBasket = [];

    db.ref('items').on('value', (snap) => { masterItems = snap.val() || {}; renderMasterList(); });
    db.ref('logs').on('value', (snap) => { renderHistory(snap.val() || {}); });

    const dropZone = document.getElementById('drop-zone');
    const excelInput = document.getElementById('excel-input');

    dropZone.onclick = () => excelInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#2563eb"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#cbd5e1"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleExcel(file);
    };
    excelInput.onchange = (e) => { if (e.target.files[0]) handleExcel(e.target.files[0]); };

    function handleExcel(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = e.target.result;
            // ì›Œí¬ë¶ì„ ì½ì„ ë•Œ cellDates ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ ë‚ ì§œ í˜•ì‹ì„ ë³´ì •
            const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // ëª¨ë“  ë°ì´í„°ë¥¼ 2ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜ (í—¤ë” ì—†ìŒ)
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            console.log("ì½ì–´ì˜¨ ë¡œìš° ë°ì´í„°:", rows); // ê°œë°œì ë„êµ¬ì—ì„œ í™•ì¸ìš©
            processExcelData(rows);
        };
        reader.readAsBinaryString(file);
    }

    function processExcelData(rows) {
        let addCount = 0;
        // ì´ë¯¸ì§€ìƒ 24í–‰ì€ ì¸ë±ìŠ¤ 23ë²ˆì…ë‹ˆë‹¤. ë°ì´í„°ê°€ ë” ì•ì´ë‚˜ ë’¤ì— ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°˜ë³µ ë²”ìœ„ë¥¼ ë„“ê²Œ ì¡ìŠµë‹ˆë‹¤.
        rows.forEach((row, index) => {
            if (index < 5) return; // ìƒë‹¨ ì œëª©ë¶€ ì œì™¸

            const menuName = String(row[5] || "").trim(); // Fì—´ (ì¸ë±ìŠ¤ 5)
            const staffName = String(row[6] || "").trim(); // Gì—´ (ì¸ë±ìŠ¤ 6)

            if (!menuName || !staffName || menuName === "ìƒì„¸ë©”ë‰´") return;

            // ë“±ë¡ëœ ë¬¼ê±´ ì¤‘ ì´ë¦„ì´ í¬í•¨ë˜ê±°ë‚˜ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            const matchedKey = Object.keys(masterItems).find(key => 
                key.trim() === menuName || menuName.includes(key.trim())
            );

            if (matchedKey) {
                const item = masterItems[matchedKey];
                selectedBasket.push({
                    staff: staffName,
                    name: matchedKey,
                    unitPrice: item.price,
                    qty: 1,
                    totalPrice: item.price,
                    category: item.category
                });
                addCount++;
            }
        });

        renderBasket();
        if (addCount === 0) {
            alert("ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ 0ê°œì…ë‹ˆë‹¤.\n1. í’ˆëª© ë¦¬ìŠ¤íŠ¸ì— ì œí’ˆ ì´ë¦„ì´ ë˜‘ê°™ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n2. íŒŒì¼ì„ .xlsx í˜•ì‹ìœ¼ë¡œ ì €ì¥ í›„ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.");
        } else {
            alert(`${addCount}ê°œì˜ í•­ëª©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        }
    }

    // --- ìˆ˜ë™ ì…ë ¥ ë° ìœ í‹¸ë¦¬í‹° ---
    function searchItem(val) {
        const box = document.getElementById('autocomplete-box');
        if(!val) { box.style.display = 'none'; return; }
        const matches = Object.keys(masterItems).filter(k => k.includes(val));
        if(matches.length > 0) {
            box.innerHTML = matches.map(m => `<div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;" onclick="addItemToBasket('${m}')">${m}</div>`).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    }

    function addItemToBasket(name) {
        const staff = document.getElementById('staff-name').value || "ë¯¸ì§€ì •";
        const qty = Number(document.getElementById('item-qty-input').value) || 1;
        selectedBasket.push({ staff, name, unitPrice: masterItems[name].price, qty, totalPrice: masterItems[name].price * qty, category: masterItems[name].category });
        renderBasket();
        document.getElementById('autocomplete-box').style.display = 'none';
        document.getElementById('item-search').value = '';
    }

    function renderBasket() {
        const display = document.getElementById('selected-items-display');
        display.innerHTML = selectedBasket.map((item, idx) => `
            <div class="added-item-tag">
                <div class="item-info"><b>[${item.staff}]</b> ${item.name} (${item.unitPrice.toLocaleString()}ì›)</div>
                <div class="item-remove" onclick="selectedBasket.splice(${idx}, 1); renderBasket();">âœ•</div>
            </div>`).join('');
        document.getElementById('total-amount').innerText = selectedBasket.reduce((s, c) => s + c.totalPrice, 0).toLocaleString();
    }

    function submitLog() {
        if(selectedBasket.length === 0) return alert("ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        selectedBasket.forEach(i => db.ref('logs').push({ ...i, timestamp: Date.now() }));
        selectedBasket = []; renderBasket(); alert("Firebase ì €ì¥ ì™„ë£Œ!");
    }

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    function regItem() {
        const name = document.getElementById('new-item-name').value;
        const price = Number(document.getElementById('new-item-price').value);
        const category = document.getElementById('new-item-category').value;
        if(name && price) db.ref('items/' + name).set({ price, category });
    }

    function renderMasterList() {
        let html = '<table><tr><th>ë¶„ë¥˜</th><th>í’ˆëª©</th><th>ë‹¨ê°€</th><th>ê´€ë¦¬</th></tr>';
        Object.entries(masterItems).forEach(([n, d]) => {
            html += `<tr><td>${d.category}</td><td>${n}</td><td>${d.price.toLocaleString()}</td><td><button class="del-btn" onclick="db.ref('items/${n}').remove()">ì‚­ì œ</button></td></tr>`;
        });
        document.getElementById('master-item-list').innerHTML = html + '</table>';
    }

    function renderHistory(logs) {
        const container = document.getElementById('history-container');
        const groups = {};
        Object.values(logs).forEach(log => {
            if(!groups[log.staff]) groups[log.staff] = { items: [], total: 0 };
            groups[log.staff].items.push(log);
            groups[log.staff].total += log.price;
        });
        let html = '';
        Object.entries(groups).forEach(([staff, data]) => {
            html += `<div class="staff-group"><div class="staff-header"><b>ğŸ‘¤ ${staff}</b> (í•©ê³„: ${data.total.toLocaleString()}ì›)</div>
            <table>${data.items.map(i => `<tr><td>${i.name}</td><td>${i.price.toLocaleString()}ì›</td></tr>`).join('')}</table></div>`;
        });
        container.innerHTML = html || '<p>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
</script>
</body>
</html>
