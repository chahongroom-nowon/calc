<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ì¥ ì •ì‚° ì‹œìŠ¤í…œ - ì§ì›ë³„ ë¶„ë¥˜ í•©ì‚°ë³¸</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 15px; position: relative; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        
        .search-flex { display: flex; gap: 10px; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 85px; background: white; border: 1px solid #ddd; z-index: 100; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .autocomplete-item.focused { background: #e0f2fe; outline: 2px solid var(--primary); }
        
        .added-item-tag { display: flex; align-items: center; justify-content: space-between; background: #eff6ff; padding: 8px 15px; border-radius: 12px; margin: 6px 0; border: 1px solid #bfdbfe; }
        .item-info { flex-grow: 1; }
        .item-qty { font-weight: bold; color: var(--primary); margin: 0 10px; }
        .item-remove { color: #ef4444; cursor: pointer; font-weight: bold; padding: 5px; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-size: 13px; }
        .staff-group { margin-bottom: 40px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .staff-header { background: #f1f5f9; padding: 15px 20px; border-bottom: 1px solid #cbd5e1; }
        .staff-name-title { font-size: 1.2rem; font-weight: bold; color: var(--text); }
        
        .staff-summary-table { background: #fff; margin: 10px 0; border: 1px solid #dbeafe; }
        .staff-summary-table th { background: #eff6ff; color: #1e40af; font-size: 11px; }
        .staff-summary-table td { font-weight: bold; color: var(--primary); font-size: 14px; }

        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .del-btn { background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('input-tab')">ë‚´ìˆ˜ ì…ë ¥</button>
        <button class="tab-btn" onclick="openTab('history-tab')">ë‚´ì—­ ë³´ê¸°</button>
        <button class="tab-btn" onclick="openTab('setting-tab')">ë¬¼ê±´ ì„¤ì • ë° ë¦¬ìŠ¤íŠ¸</button>
    </div>

    <div id="input-tab" class="tab-content active">
        <h2>âœï¸ ë‚´ìˆ˜ ì •ì‚° ì…ë ¥</h2>
        <div class="form-group">
            <label>ì§ì› ì´ë¦„</label>
            <input type="text" id="staff-name" placeholder="ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="form-group">
            <label>ë¬¼ê±´ ê²€ìƒ‰ ë° ìˆ˜ëŸ‰ (ë°©í–¥í‚¤ â†‘â†“)</label>
            <div class="search-flex">
                <div style="flex-grow: 1; position: relative;">
                    <input type="text" id="item-search" placeholder="ì œí’ˆëª… ì…ë ¥" oninput="searchItem(this.value)" onkeydown="handleKeyDown(event)">
                    <div id="autocomplete-box" class="autocomplete-list" style="display:none;"></div>
                </div>
                <input type="number" id="item-qty-input" value="1" min="1" style="width: 75px; text-align: center;">
            </div>
        </div>

        <div id="selected-items-display"></div>
        <div style="margin: 20px 0; font-size: 1.2rem;"><strong>ì´ í•©ê³„: <span id="total-amount" style="color:var(--primary)">0</span>ì›</strong></div>
        <button class="main-btn" onclick="submitLog()">ì •ì‚° ë°ì´í„° ì „ì†¡ (Enter)</button>
    </div>

    <div id="history-tab" class="tab-content">
        <h2>ğŸ‘¤ ì§ì›ë³„ ìƒì„¸ ì •ì‚° ë³´ê³ ì„œ</h2>
        <div id="history-container"></div>
    </div>

    <div id="setting-tab" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h2>ğŸ›  ìƒˆ ë¬¼ê±´ ë“±ë¡</h2>
                <div class="form-group">
                    <label>ë¶„ë¥˜</label>
                    <select id="new-item-category">
                        <option value="ì§ì›ë‚´ìˆ˜">ì§ì›ë‚´ìˆ˜</option>
                        <option value="CL">CL</option>
                        <option value="ê°€ë°œ">ê°€ë°œ</option>
                        <option value="ë¸”ë¡œê±°ST">ë¸”ë¡œê±°ST</option>
                        <option value="ì¬ì‹œìˆ ">ì¬ì‹œìˆ </option>
                        <option value="ëª…í•¨">ëª…í•¨</option>
                    </select>
                </div>
                <div class="form-group"><input type="text" id="new-item-name" placeholder="í’ˆëª©ëª…"></div>
                <div class="form-group"><input type="number" id="new-item-price" placeholder="ë‹¨ê°€"></div>
                <button class="main-btn" style="background:#475569" onclick="regItem()">ë¬¼ê±´ ë“±ë¡</button>
            </div>
            <div>
                <h2>ğŸ“‹ ë“±ë¡ëœ ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸</h2>
                <div id="master-item-list" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCGI5gtzwYM9vyRMS5qhTaNsFZ8rZDK-o",
        authDomain: "clac-efaab.firebaseapp.com",
        databaseURL: "https://clac-efaab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "clac-efaab",
        appId: "1:94106141769:web:5391ba91c0300bf652ab98"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let masterItems = {};
    let selectedBasket = [];
    let focusedIndex = -1;

    db.ref('items').on('value', (snap) => { masterItems = snap.val() || {}; renderMasterList(); });
    db.ref('logs').on('value', (snap) => { renderHistory(snap.val() || {}); });

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function handleKeyDown(e) {
        const items = document.querySelectorAll('.autocomplete-item');
        if (e.key === 'ArrowDown') { focusedIndex = (focusedIndex + 1) % items.length; updateFocus(items); e.preventDefault(); }
        else if (e.key === 'ArrowUp') { focusedIndex = (focusedIndex - 1 + items.length) % items.length; updateFocus(items); e.preventDefault(); }
        else if (e.key === 'Enter') { if (focusedIndex > -1) { items[focusedIndex].click(); e.preventDefault(); } }
    }

    function updateFocus(items) {
        items.forEach((item, idx) => {
            item.classList.toggle('focused', idx === focusedIndex);
            if(idx === focusedIndex) item.scrollIntoView({ block: 'nearest' });
        });
    }

    function searchItem(val) {
        const box = document.getElementById('autocomplete-box');
        focusedIndex = -1;
        if(!val) { box.style.display = 'none'; return; }
        const matches = Object.keys(masterItems).filter(k => k.toLowerCase().includes(val.toLowerCase()));
        if(matches.length > 0) {
            box.innerHTML = matches.map(m => `<div class="autocomplete-item" onclick="addItemToBasket('${m}')">${m} (${masterItems[m].price.toLocaleString()}ì›)</div>`).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    }

    function addItemToBasket(name) {
        const qty = Number(document.getElementById('item-qty-input').value) || 1;
        selectedBasket.push({ name, unitPrice: masterItems[name].price, qty, totalPrice: masterItems[name].price * qty, category: masterItems[name].category });
        document.getElementById('item-search').value = '';
        document.getElementById('item-qty-input').value = '1';
        document.getElementById('autocomplete-box').style.display = 'none';
        renderBasket();
        document.getElementById('item-search').focus();
    }

    function renderBasket() {
        const display = document.getElementById('selected-items-display');
        display.innerHTML = selectedBasket.map((item, idx) => `
            <div class="added-item-tag">
                <div class="item-info"><strong>${item.name}</strong> (${item.unitPrice.toLocaleString()}ì›)</div>
                <div class="item-qty">x ${item.qty}ê°œ</div>
                <div style="width: 90px; text-align: right;">${item.totalPrice.toLocaleString()}ì›</div>
                <div class="item-remove" onclick="removeFromBasket(${idx})">âœ•</div>
            </div>`).join('');
        document.getElementById('total-amount').innerText = selectedBasket.reduce((s, c) => s + c.totalPrice, 0).toLocaleString();
    }

    function removeFromBasket(idx) { selectedBasket.splice(idx, 1); renderBasket(); }

    function regItem() {
        const cat = document.getElementById('new-item-category').value;
        const name = document.getElementById('new-item-name').value;
        const price = document.getElementById('new-item-price').value;
        if(name && price) db.ref('items/' + name).set({ price: Number(price), category: cat });
        document.getElementById('new-item-name').value = ''; document.getElementById('new-item-price').value = '';
    }

    function renderMasterList() {
        let html = '<table><thead><tr><th>ë¶„ë¥˜</th><th>í’ˆëª©</th><th>ë‹¨ê°€</th><th>ì‚­ì œ</th></tr></thead><tbody>';
        Object.entries(masterItems).forEach(([n, d]) => { html += `<tr><td>${d.category}</td><td>${n}</td><td>${d.price.toLocaleString()}</td><td><button class="del-btn" onclick="deleteMasterItem('${n}')">ì‚­ì œ</button></td></tr>`; });
        document.getElementById('master-item-list').innerHTML = html + '</tbody></table>';
    }

    function deleteMasterItem(name) { if(confirm('ì˜êµ¬ ì‚­ì œ?')) db.ref('items/' + name).remove(); }

    function submitLog() {
        const staff = document.getElementById('staff-name').value;
        if(!staff || selectedBasket.length === 0) return alert("ì…ë ¥ í™•ì¸!");
        selectedBasket.forEach(item => { db.ref('logs').push({ staff, itemName: item.name, qty: item.qty, price: item.totalPrice, category: item.category, timestamp: Date.now() }); });
        selectedBasket = []; renderBasket(); document.getElementById('staff-name').value = ''; alert("ì „ì†¡ ì™„ë£Œ");
    }

    // [ìµœì¢… ìˆ˜ì •] ë‚´ì—­ ë³´ê¸°: ì§ì› ì„¹ì…˜ ë‚´ë¶€ì— ë¶„ë¥˜ë³„ ìš”ì•½ ì¶”ê°€
    function renderHistory(logs) {
        const container = document.getElementById('history-container');
        const staffGroups = {};
        const categories = ["ì§ì›ë‚´ìˆ˜", "CL", "ê°€ë°œ", "ë¸”ë¡œê±°ST", "ì¬ì‹œìˆ ", "ëª…í•¨"];

        Object.entries(logs).forEach(([id, log]) => {
            if (!staffGroups[log.staff]) {
                staffGroups[log.staff] = { items: [], catTotals: { "ì§ì›ë‚´ìˆ˜": 0, "CL": 0, "ê°€ë°œ": 0, "ë¸”ë¡œê±°ST": 0, "ì¬ì‹œìˆ ": 0, "ëª…í•¨": 0 }, total: 0 };
            }
            staffGroups[log.staff].items.push(log);
            staffGroups[log.staff].catTotals[log.category] += log.price;
            staffGroups[log.staff].total += log.price;
        });

        let html = '';
        Object.entries(staffGroups).forEach(([staff, data]) => {
            html += `
            <div class="staff-group">
                <div class="staff-header">
                    <div class="staff-name-title">ğŸ‘¤ ${staff}ë‹˜ ì •ì‚° ìš”ì•½</div>
                    <table class="staff-summary-table">
                        <tr>${categories.map(c => `<th>${c}</th>`).join('')} <th style="background:#2563eb; color:#fff;">ì´ í•©ê³„</th></tr>
                        <tr>${categories.map(c => `<td>${data.catTotals[c].toLocaleString()}</td>`).join('')} <td>${data.total.toLocaleString()}ì›</td></tr>
                    </table>
                </div>
                <table>
                    <thead><tr><th>ë¶„ë¥˜</th><th>í’ˆëª©</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr></thead>
                    <tbody>${data.items.map(i => `<tr><td>${i.category}</td><td>${i.itemName}</td><td>${i.qty || 1}</td><td>${i.price.toLocaleString()}ì›</td></tr>`).join('')}</tbody>
                </table>
            </div>`;
        });
        container.innerHTML = html || '<p>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
</script>
</body>
</html>
