<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ì¥ ì •ì‚° ì‹œìŠ¤í…œ - ìµœì¢… í†µí•©ë³¸</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .drop-zone { border: 3px dashed #cbd5e1; border-radius: 12px; padding: 50px; text-align: center; color: #475569; background: #f8fafc; cursor: pointer; margin-bottom: 20px; }
        .added-item-tag { display: flex; align-items: center; justify-content: space-between; background: #eff6ff; padding: 12px; border-radius: 12px; margin: 8px 0; border: 1px solid #bfdbfe; }
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .staff-group { margin-bottom: 40px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: #fff; }
        .staff-header { background: #f1f5f9; padding: 15px 20px; border-bottom: 1px solid #cbd5e1; }
        .summary-table { width: 100%; background: #fff; margin: 10px 0; border-collapse: collapse; }
        .summary-table th { background: #eff6ff; color: #1e40af; font-size: 11px; padding: 8px; border: 1px solid #dbeafe; }
        .summary-table td { font-weight: bold; color: var(--primary); font-size: 13px; padding: 8px; text-align: center; border: 1px solid #dbeafe; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-size: 13px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('input-tab')">ë‚´ìˆ˜ ì…ë ¥</button>
        <button class="tab-btn" onclick="openTab('history-tab')">ë‚´ì—­ ë³´ê¸°</button>
        <button class="tab-btn" onclick="openTab('setting-tab')">ë¬¼ê±´ ì„¤ì •</button>
    </div>

    <div id="input-tab" class="tab-content active">
        <h2>ğŸ“‚ ì—‘ì…€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê°€ì§œ XLS ëŒ€ì‘)</h2>
        <div id="drop-zone" class="drop-zone" onclick="document.getElementById('excel-input').click()">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”.</div>
        <input type="file" id="excel-input" style="display:none;">

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">

        <h2>âœï¸ ìˆ˜ë™ ì •ì‚° ì…ë ¥</h2>
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ì§ì› ì´ë¦„</label>
            <input type="text" id="staff-name" placeholder="ì´ë¦„ ì…ë ¥">
        </div>
        <div style="margin-bottom:15px; position:relative;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ë¬¼ê±´ ê²€ìƒ‰</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="item-search" placeholder="ì œí’ˆëª… ì…ë ¥" oninput="searchItem(this.value)" style="flex-grow:1;">
                <input type="number" id="item-qty-input" value="1" min="1" style="width:80px; text-align:center;">
            </div>
            <div id="autocomplete-box" style="position:absolute; background:white; border:1px solid #ddd; width:100%; z-index:100; display:none; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>

        <div id="selected-items-display"></div>
        <div style="margin: 20px 0; font-size: 1.2rem;"><strong>ì „ì†¡ ëŒ€ê¸° í•©ê³„: <span id="total-amount" style="color:var(--primary)">0</span>ì›</strong></div>
        <button class="main-btn" onclick="submitLog()">Firebase ìµœì¢… ì „ì†¡</button>
    </div>

    <div id="history-tab" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>ğŸ‘¤ ì§ì›ë³„ ìƒì„¸ ì •ì‚° ë³´ê³ ì„œ</h2>
            <div>
                <button onclick="exportToExcel()" style="padding:10px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“Š ì—‘ì…€ ë°±ì—…</button>
                <button onclick="resetLogs()" style="padding:10px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">âš ï¸ ì´ˆê¸°í™”</button>
            </div>
        </div>
        <div id="history-container"></div>
    </div>

    <div id="setting-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h2>ğŸ›  ìƒˆ ë¬¼ê±´ ë“±ë¡</h2>
                <input type="text" id="new-item-name" placeholder="í’ˆëª©ëª…" style="margin-bottom:10px;">
                <input type="number" id="new-item-price" placeholder="ë‹¨ê°€" style="margin-bottom:10px;">
                <select id="new-item-category" style="margin-bottom:10px;">
                    <option value="ì§ì›ë‚´ìˆ˜">ì§ì›ë‚´ìˆ˜</option><option value="CL">CL</option><option value="ê°€ë°œ">ê°€ë°œ</option>
                    <option value="ë¸”ë¡œê±°ST">ë¸”ë¡œê±°ST</option><option value="ì¬ì‹œìˆ ">ì¬ì‹œìˆ </option><option value="ëª…í•¨">ëª…í•¨</option>
                </select>
                <button class="main-btn" onclick="regItem()">ë¬¼ê±´ ë“±ë¡</button>
            </div>
            <div id="master-item-list"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCGI5gtzwYM9vyRMS5qhTaNsFZ8rZDK-o",
        authDomain: "clac-efaab.firebaseapp.com",
        databaseURL: "https://clac-efaab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "clac-efaab",
        appId: "1:94106141769:web:5391ba91c0300bf652ab98"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let masterItems = {};
    let selectedBasket = [];
    let currentLogs = {};
    const categories = ["ì§ì›ë‚´ìˆ˜", "CL", "ê°€ë°œ", "ë¸”ë¡œê±°ST", "ì¬ì‹œìˆ ", "ëª…í•¨"];

    db.ref('items').on('value', (snap) => { masterItems = snap.val() || {}; renderMasterList(); });
    db.ref('logs').on('value', (snap) => { currentLogs = snap.val() || {}; renderHistory(currentLogs); });

    // ì—‘ì…€ ë¶„ì„ (ì§€ëŠ¥í˜• ìŠ¤ìº”)
    const excelInput = document.getElementById('excel-input');
    excelInput.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, { type: 'array', codepage: 949 });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            
            let count = 0;
            rows.forEach((row) => {
                const menu = String(row[5] || "").trim(); // Fì—´
                const staff = String(row[6] || "").trim(); // Gì—´
                const matchedKey = Object.keys(masterItems).find(k => k.replace(/\s/g, "") === menu.replace(/\s/g, ""));
                
                if (matchedKey && staff && menu !== "ìƒì„¸ë©”ë‰´") {
                    const info = masterItems[matchedKey];
                    selectedBasket.push({
                        staff, itemName: matchedKey, price: Number(info.price || 0),
                        category: info.category || "ì§ì›ë‚´ìˆ˜", timestamp: Date.now()
                    });
                    count++;
                }
            });
            renderBasket();
            alert(count + "ê°œë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.");
        };
        reader.readAsArrayBuffer(file);
    };

    // ìˆ˜ë™ ì…ë ¥
    function searchItem(val) {
        const box = document.getElementById('autocomplete-box');
        if(!val) { box.style.display = 'none'; return; }
        const matches = Object.keys(masterItems).filter(k => k.includes(val));
        if(matches.length > 0) {
            box.innerHTML = matches.map(m => `<div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;" onclick="addItemToBasket('${m}')">${m} (${Number(masterItems[m].price).toLocaleString()}ì›)</div>`).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    }

    function addItemToBasket(name) {
        const staff = document.getElementById('staff-name').value || "ë¯¸ì§€ì •";
        const qty = Number(document.getElementById('item-qty-input').value) || 1;
        const info = masterItems[name];
        selectedBasket.push({ staff, itemName: name, price: Number(info.price || 0) * qty, category: info.category || "ì§ì›ë‚´ìˆ˜", timestamp: Date.now() });
        renderBasket();
        document.getElementById('autocomplete-box').style.display = 'none';
        document.getElementById('item-search').value = '';
    }

    function renderBasket() {
        const display = document.getElementById('selected-items-display');
        display.innerHTML = selectedBasket.map((item, idx) => `
            <div class="added-item-tag">
                <div><b>[${item.staff}]</b> ${item.itemName} (${item.category}) - ${Number(item.price).toLocaleString()}ì›</div>
                <div style="cursor:pointer; color:red;" onclick="selectedBasket.splice(${idx},1); renderBasket();">âœ•</div>
            </div>`).join('');
        const total = selectedBasket.reduce((s, c) => s + Number(c.price || 0), 0);
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    function submitLog() {
        if(selectedBasket.length === 0) return alert("ë°ì´í„° ì—†ìŒ");
        selectedBasket.forEach(i => db.ref('logs').push(i));
        selectedBasket = []; renderBasket(); alert("ì €ì¥ ì™„ë£Œ!");
    }

    // ë‚´ì—­ ë³´ê¸° (ë¶„ë¥˜ë³„ ìš”ì•½ ë³µêµ¬)
    function renderHistory(logs) {
        const container = document.getElementById('history-container');
        const groups = {};
        Object.values(logs).forEach(l => {
            if(!groups[l.staff]) {
                groups[l.staff] = { items: [], total: 0, catTotals: {} };
                categories.forEach(c => groups[l.staff].catTotals[c] = 0);
            }
            groups[l.staff].items.push(l);
            const p = Number(l.price || 0);
            groups[l.staff].total += p;
            groups[l.staff].catTotals[l.category || "ì§ì›ë‚´ìˆ˜"] += p;
        });

        let html = '';
        Object.entries(groups).forEach(([staff, data]) => {
            html += `<div class="staff-group">
                <div class="staff-header"><b>ğŸ‘¤ ${staff}ë‹˜ ì •ì‚° ìš”ì•½</b></div>
                <table class="summary-table">
                    <tr>${categories.map(c => `<th>${c}</th>`).join('')} <th style="background:#2563eb; color:#fff;">ì´í•©ê³„</th></tr>
                    <tr>${categories.map(c => `<td>${data.catTotals[c].toLocaleString()}</td>`).join('')} <td>${data.total.toLocaleString()}ì›</td></tr>
                </table>
                <table>
                    <thead><tr><th>ë¶„ë¥˜</th><th>í’ˆëª©</th><th>ê¸ˆì•¡</th></tr></thead>
                    <tbody>${data.items.map(i => `<tr><td>${i.category || 'ë¯¸ë¶„ë¥˜'}</td><td>${i.itemName}</td><td>${Number(i.price || 0).toLocaleString()}ì›</td></tr>`).join('')}</tbody>
                </table>
            </div>`;
        });
        container.innerHTML = html || '<p>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // ê¸°íƒ€ ê´€ë¦¬
    function resetLogs() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref('logs').remove(); }
    function exportToExcel() {
        const data = Object.values(currentLogs).map(l => ({ "ë‚ ì§œ": new Date(l.timestamp).toLocaleString(), "ì§ì›": l.staff, "ë¶„ë¥˜": l.category, "í’ˆëª©": l.itemName, "ê¸ˆì•¡": l.price }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ì •ì‚°");
        XLSX.writeFile(wb, "ì •ì‚°ë°±ì—….xlsx");
    }
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); if(event) event.currentTarget.classList.add('active');
    }
    function regItem() {
        const name = document.getElementById('new-item-name').value;
        const price = Number(document.getElementById('new-item-price').value || 0);
        const category = document.getElementById('new-item-category').value;
        if(name) db.ref('items/' + name).set({ price, category });
    }
    function renderMasterList() {
        let html = '<table><tr><th>ë¶„ë¥˜</th><th>í’ˆëª©</th><th>ë‹¨ê°€</th><th>ì‚­ì œ</th></tr>';
        Object.entries(masterItems).forEach(([n, d]) => {
            html += `<tr><td>${d.category}</td><td>${n}</td><td>${(d.price || 0).toLocaleString()}</td><td><button onclick="db.ref('items/${n}').remove()">ì‚­ì œ</button></td></tr>`;
        });
        document.getElementById('master-item-list').innerHTML = html + '</table>';
    }
</script>
</body>
</html>
